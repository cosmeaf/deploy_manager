{% extends 'base.html' %}

{% block title %}Cadastrar Projeto{% endblock %}

{% block content %}
<div class="card shadow-sm p-4">
    <h2 class="mb-4"><i class="fas fa-plus-circle me-2"></i>Cadastrar Novo Projeto Git</h2>

    <form method="post">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <div class="mb-3">
            <label for="{{ form.name.id_for_label }}" class="form-label">Nome do Projeto</label>
            {{ form.name }}
            {% if form.name.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.name.errors }}
                </div>
            {% endif %}
        </div>

        <div class="mb-3">
            <label for="{{ form.repository_url.id_for_label }}" class="form-label">URL do Repositório</label>
            {{ form.repository_url }}
            {% if form.repository_url.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.repository_url.errors }}
                </div>
            {% endif %}
        </div>

        <div class="mb-3">
            <label for="{{ form.webhook_secret.id_for_label }}" class="form-label">Token de Webhook</label>
            <div class="input-group">
                {{ form.webhook_secret }}
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="generateToken()">Gerar</button>
            </div>
            {% if form.webhook_secret.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.webhook_secret.errors }}
                </div>
            {% endif %}
            <small class="form-text text-muted">Deixe em branco para gerar automaticamente ou clique em "Gerar" para criar um novo token.</small>
        </div>

        <div class="d-flex justify-content-end gap-2">
            <button type="submit" class="btn btn-primary btn-sm">Salvar</button>
            <a href="{% url 'monitor_projects' %}" class="btn btn-secondary btn-sm">Voltar</a>
        </div>
    </form>

    {% if webhook_hint %}
    <div class="mt-4 p-3 border rounded bg-light">
        <h5><i class="fas fa-link me-2"></i>Webhook configurado</h5>
        <p class="mb-1">Copie a URL abaixo e configure como um webhook no GitHub:</p>
        <div class="input-group mb-2">
            <code class="form-control bg-white border" id="webhook-url">{{ webhook_hint }}</code>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="copyToClipboard('webhook-url')">Copiar</button>
        </div>
        <ol class="small text-muted mb-0">
            <li>Acesse o repositório no GitHub</li>
            <li>Vá em <strong>Settings → Webhooks → Add webhook</strong></li>
            <li>Insira a URL acima em <code>Payload URL</code></li>
            <li>Escolha o tipo <code>application/json</code></li>
            <li>Cole o token no campo <strong>Secret</strong></li>
            <li>Escolha o gatilho <code>Just the push event</code></li>
            <li>Salve o webhook</li>
        </ol>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
function generateToken() {
    const token = [...Array(40)].map(() => Math.floor(Math.random() * 16).toString(16)).join('');
    const input = document.getElementById("id_webhook_secret");
    if (input) {
        input.value = token;
    } else {
        alert('Campo webhook_secret não encontrado!');
    }
}

function copyToClipboard(elementId) {
    const text = document.getElementById(elementId).textContent;
    navigator.clipboard.writeText(text).then(() => {
        alert('URL copiada para a área de transferência!');
    }).catch(() => {
        alert('Falha ao copiar a URL.');
    });
}
</script>
{% endblock %}